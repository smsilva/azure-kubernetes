#!/bin/bash
export THIS_SCRIPT_DIRECTORY=$(dirname $0)
export PATH=${PATH}:${THIS_SCRIPT_DIRECTORY}
export EXECUTION_ID="$(date +"%Y-%m-%d_%H-%M-%S")_$(uuidgen)"
export CACHE_DIRECTORY="${THIS_SCRIPT_DIRECTORY}/.cache/${EXECUTION_ID}"

mkdir -p "${CACHE_DIRECTORY}"

show_usage() {
  cat <<EOF

  ./aks-node-rollout-restart \\
    --cluster-name aks-cluster-example \\
    --resource-group aks-cluster-example \\
    --name aks-systempool-37832835-vmss000000 \\
    --dry-run

EOF
}

while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do
case $1 in
  -h | --help )
    show_usage
    exit
    ;;
  -cn | --cluster-name )
    shift; AKS_CLUSTER_NAME=$1
    ;;
  -rg | --resource-group )
    shift; AKS_CLUSTER_RESOURCE_GROUP_NAME=$1
    ;;
  -n | --name )
    shift; AKS_NODE_NAME=$1
    ;;
  -d | --debug )
    shift; DEBUG_LEVEL=$1
    ;;
  --dry-run )
    shift; DRY_RUN="y"
    ;;
esac; shift; done

if [[ "$1" == '--' ]]; then shift; fi

DRY_RUN=${DRY_RUN-n}
DEBUG_LEVEL=${DEBUG_LEVEL-1}

if [ -z "${AKS_CLUSTER_NAME}"                ] || \
   [ -z "${AKS_CLUSTER_RESOURCE_GROUP_NAME}" ] || \
   [ -z "${AKS_NODE_NAME}"                   ]; then
  show_usage
  exit 1
fi

if ! which kubectl &> /dev/null; then
  az aks install-cli
fi

KUBECTL_CONFIG_CONTEXT_EXISTS=$(kubectl config get-contexts | grep ${AKS_CLUSTER_NAME} | wc -l)

if [ "${KUBECTL_CONFIG_CONTEXT_EXISTS}" == "0" ]; then
  az aks get-credentials \
    --name ${AKS_CLUSTER_NAME?} \
    --resource-group ${AKS_CLUSTER_RESOURCE_GROUP_NAME?} \
    --overwrite-existing \
    --admin
fi

log() {
  MESSAGE="$1"

  echo "$(date +"%Y-%m-%d %H:%M:%S") ${MESSAGE}"
}

deployment_file() {
  DEPLOYMENT_NAMESPACE=$1
  DEPLOYMENT_NAME=$2

  mkdir -p "${CACHE_DIRECTORY}/${DEPLOYMENT_NAMESPACE}"

  FILE_NAME="${CACHE_DIRECTORY}/${DEPLOYMENT_NAMESPACE}/${DEPLOYMENT_NAME}"

  echo "${FILE_NAME}"
}

collect_deployments_info() {
  kubectl get deployments \
    --all-namespaces \
    --no-headers \
    --output wide \
  | sort \
  | while read LINE; do
    DEPLOYMENT_NAMESPACE=$(awk '{ print $1 }' <<< "${LINE}")
    DEPLOYMENT_NAME=$(     awk '{ print $2 }' <<< "${LINE}")
    DEPLOYMENT_SELECTORS=$(awk '{ print $9 }' <<< "${LINE}")

    if [ "${DEBUG_LEVEL}" -gt 1 ]; then
      log "[${DEPLOYMENT_NAMESPACE}] ${DEPLOYMENT_NAME} [${DEPLOYMENT_SELECTORS}]"
    else
      if [ "${DEBUG_LEVEL}" -gt 0 ]; then
        log "[${DEPLOYMENT_NAMESPACE}] ${DEPLOYMENT_NAME}"
      fi
    fi

    kubectl get pod \
      --namespace "${DEPLOYMENT_NAMESPACE}" \
      --selector  "${DEPLOYMENT_SELECTORS}" \
      --output jsonpath='{range .items[*]}{.metadata.name} {.spec.nodeName}{"\n"}{end}' \
      | while read POD_LINE; do
          POD_NAME=$(     awk '{ print $1 }' <<< "${POD_LINE}")
          POD_NODE_NAME=$(awk '{ print $2 }' <<< "${POD_LINE}")

          FILE_NAME=$(deployment_file "${DEPLOYMENT_NAMESPACE}" "${DEPLOYMENT_NAME}")

          echo "${POD_NODE_NAME?} ${POD_NAME?}" >> "${FILE_NAME}"
    done
  done
}

node_cordon() {
  NODE_NAME=$1

  if [ "${DRY_RUN}" != "y" ]; then
    kubectl cordon ${NODE_NAME?}
  else
    log "[${NODE_NAME?}] cordoned"
  fi
}

node_list() {
  NODE_NAME=$1

  kubectl get nodes \
    --output jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' \
  | grep -E "${NODE_NAME}"
}

rollout_restart_deployments() {
  NODE_NAME=$1

  grep -rl "${NODE_NAME?}" "${CACHE_DIRECTORY}" \
  | while read LINE; do
    DEPLOYMENT_DIRECTORY=$(dirname "${LINE}")
    DEPLOYMENT_NAMESPACE=$(awk -F '/' '{ print $4 }' <<< "${LINE}")
    DEPLOYMENT_NAME=$(     awk -F '/' '{ print $5 }' <<< "${LINE}")
    DEPLOYMENT_MARK="${DEPLOYMENT_DIRECTORY?}/${DEPLOYMENT_NAME?}.rollout"

    if ! [ -e "${DEPLOYMENT_MARK}" ]; then
      echo "${NODE_NAME?}" $(date +"%Y-%m-%d %H:%M:%S") > "${DEPLOYMENT_MARK}"

      log "[${NODE_NAME?}] rollout restart deployment ${DEPLOYMENT_NAMESPACE?}.${DEPLOYMENT_NAME?}"

      if [ "${DRY_RUN}" != "y" ]; then
        kubectl \
          --namespace ${DEPLOYMENT_NAMESPACE?} \
          rollout restart deployment ${DEPLOYMENT_NAME?} > /dev/null
      fi
    fi
  done
}

node_rollout_restart_deployments() {
  while read -r NODE_NAME; do
    node_cordon ${NODE_NAME?}
    rollout_restart_deployments ${NODE_NAME?}
  done
}

log "Collecting Deployments Info..."

collect_deployments_info

log ""
log "Initiating Deployments Rollout Restart..."
log ""

if [ -n "${AKS_NODE_NAME}" ]; then
  node_list "${AKS_NODE_NAME}" \
  | node_rollout_restart_deployments
else
  node_list \
  | head -${AKS_NODE_COUNT} \
  | node_rollout_restart_deployments
fi

log ""
log "Done"
