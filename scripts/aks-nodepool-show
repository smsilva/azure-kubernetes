#!/bin/bash
export THIS_SCRIPT_DIRECTORY=$(dirname $0)
export PATH=${PATH}:${THIS_SCRIPT_DIRECTORY}

show_usage() {
  cat <<EOF

  ./aks-nodepool-show \\
    --cluster-name   aks-cluster-example \\
    --resource-group aks-cluster-example

EOF
}

while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do
case $1 in
  -h | --help )
    show_usage
    exit
    ;;

  -cn | --cluster-name )
    shift; AKS_CLUSTER_NAME=$1
    ;;

  -rg | --resource-group )
    shift; AKS_CLUSTER_RESOURCE_GROUP_NAME=$1
    ;;
esac; shift; done

if [[ "$1" == '--' ]]; then shift; fi

DRY_RUN=${DRY_RUN-n}

if [ -z "${AKS_CLUSTER_NAME}"                ] || \
   [ -z "${AKS_CLUSTER_RESOURCE_GROUP_NAME}" ]; then
  show_usage
  exit 1
fi

get_nodepool_list() {
  az aks nodepool list \
    --cluster-name ${AKS_CLUSTER_NAME?} \
    --resource-group ${AKS_CLUSTER_RESOURCE_GROUP_NAME?} \
    --output tsv \
    --query '[].name'
}

(
  HEADER_LINE_1="Name         Min     Max     Count   Space   MaxPods   KubernetesVersion   Mode     NodeSize            ProvisioningState "
  HEADER_LINE_2="-----------  ------  ------  ------  ------  --------  ------------------  -------  ------------------  ------------------"

  echo "${HEADER_LINE_1?}"
  echo "${HEADER_LINE_2?}"

  TOTAL_MIN=0
  TOTAL_MAX=0
  TOTAL_COUNT=0
  TOTAL_SPACE=0

  while read NODEPOOL_NAME; do
    unset AKS_NODEPOOL_MIN_COUNT
    unset AKS_NODEPOOL_MAX_COUNT
    unset AKS_NODEPOOL_COUNT
    unset AKS_NODEPOOL_MAX_PODS
    unset AKS_NODEPOOL_ORCHESTRATOR_VERSION
    unset AKS_NODEPOOL_VM_SIZE
    unset AKS_NODEPOOL_MODE

    eval $(
      aks-nodepool-info \
        --cluster-name ${AKS_CLUSTER_NAME?} \
        --resource-group ${AKS_CLUSTER_RESOURCE_GROUP_NAME?} \
        --name ${NODEPOOL_NAME?}
    )

    AKS_NODEPOOL_SPACE_COUNT=$((${AKS_NODEPOOL_MAX_COUNT-0} - ${AKS_NODEPOOL_COUNT-0}))

    printf "%s " ${NODEPOOL_NAME}
    printf "%s " ${AKS_NODEPOOL_MIN_COUNT}
    printf "%s " ${AKS_NODEPOOL_MAX_COUNT}
    printf "%s " ${AKS_NODEPOOL_COUNT}
    printf "%s " ${AKS_NODEPOOL_SPACE_COUNT}
    printf "%s " ${AKS_NODEPOOL_MAX_PODS}
    printf "%s " ${AKS_NODEPOOL_ORCHESTRATOR_VERSION}
    printf "%s " ${AKS_NODEPOOL_MODE}
    printf "%s " ${AKS_NODEPOOL_VM_SIZE}
    printf "%s\n" ${AKS_NODEPOOL_PROVISIONING_STATE}

    TOTAL_MIN=$((${TOTAL_MIN} + ${AKS_NODEPOOL_MIN_COUNT-0}))
    TOTAL_MAX=$((${TOTAL_MAX} + ${AKS_NODEPOOL_MAX_COUNT-0}))
    TOTAL_COUNT=$((${TOTAL_COUNT} + ${AKS_NODEPOOL_COUNT-0}))
    TOTAL_SPACE=$((${TOTAL_SPACE} + ${AKS_NODEPOOL_SPACE_COUNT-0}))
  done <<< "$(get_nodepool_list)"

  echo "${HEADER_LINE_2?}"
  echo "Total ${TOTAL_MIN} ${TOTAL_MAX} ${TOTAL_COUNT} ${TOTAL_SPACE}"
) \
| column -t
